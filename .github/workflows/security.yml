name: Security

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run security scan weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: read
  security-events: write

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: 5.9

    - name: Cache Swift packages
      uses: actions/cache@v3
      with:
        path: .build
        key: ${{ runner.os }}-swift-security-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-security-

    - name: Resolve dependencies
      run: swift package resolve

    - name: Check for known vulnerabilities
      run: |
        # This is a placeholder for Swift dependency vulnerability scanning
        # You can integrate with tools like:
        # - OWASP Dependency Check
        # - Snyk
        # - GitHub's own dependency scanning (if available for Swift)
        echo "Checking for known vulnerabilities in Swift dependencies..."
        
        # For now, we'll just ensure dependencies resolve without issues
        swift package show-dependencies --format json > dependencies.json
        
        # Check if any dependencies have security advisories (manual check for now)
        echo "Dependencies resolved successfully. Manual security review recommended for production use."

  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified